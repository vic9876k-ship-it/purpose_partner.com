<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - PurposePartner</title>
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-512.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Firebase SDK for Auth + Firestore -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        signOut as firebaseSignOut,
        onAuthStateChanged,
        updateProfile
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
    import { 
        getFirestore, 
        collection, 
        doc, 
        addDoc, 
        getDoc, 
        getDocs, 
        updateDoc, 
        query, 
        where, 
        orderBy, 
        limit,
        onSnapshot,
        deleteDoc,
        setDoc
    } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyC4HhpXcYdGhvFRIz4IHksilgnMnRDbiS8",
        authDomain: "victory-fb944.firebaseapp.com",
        projectId: "victory-fb944",
        storageBucket: "victory-fb944.firebasestorage.app",
        messagingSenderId: "650310438797",
        appId: "1:650310438797:web:c0bd9a1caaa6093d5137c4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // Make globally available
    window.auth = auth;
    window.db = db;
    window.googleProvider = googleProvider;
    window.firebaseAuth = { 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        signInWithPopup,
        firebaseSignOut,
        onAuthStateChanged,
        updateProfile,
        GoogleAuthProvider
    };
    window.firestore = { collection, doc, addDoc, getDoc, getDocs, updateDoc, query, where, orderBy, limit, onSnapshot, deleteDoc, setDoc };

    // Ensure user document exists in Firestore
    async function ensureUserDocument(user) {
        const userDocRef = window.firestore.doc(window.db, 'users', user.uid);
        const userDoc = await window.firestore.getDoc(userDocRef);
        
        if (!userDoc.exists()) {
            // Create new user document with zero stats
            await window.firestore.setDoc(userDocRef, {
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || user.email.split('@')[0],
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                partners: [],
                encouragementCount: 0,
                prayerCount: 0,
                victoryCount: 0,
                milestoneCount: 0,
                totalEncouragements: 0
            });
        } else {
            // Update last login and ensure displayName exists
            const userData = userDoc.data();
            await window.firestore.updateDoc(userDocRef, {
                lastLogin: new Date().toISOString(),
                displayName: userData.displayName || user.displayName || user.email.split('@')[0]
            });
        }
    }

    // Handle sign in
    async function handleSignIn(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error-message');
        
        try {
            const userCredential = await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
            console.log('Signed in:', userCredential.user);
            
            // Ensure user document exists in Firestore
            await ensureUserDocument(userCredential.user);
            
            // Store login state
            sessionStorage.setItem('loggedInUser', email);
        } catch (error) {
            console.error('Sign in error:', error);
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    }

    // Handle Google sign in
    async function handleGoogleSignIn() {
        const errorDiv = document.getElementById('error-message');
        try {
            const result = await window.firebaseAuth.signInWithPopup(window.auth, window.googleProvider);
            console.log('Google sign in:', result.user);
            
            // Ensure user document exists in Firestore
            await ensureUserDocument(result.user);
            
            // Store login state
            sessionStorage.setItem('loggedInUser', result.user.email);
        } catch (error) {
            console.error('Google sign in error:', error);
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    }

    // MASTER AUTH LOGIC
    let authResolved = false;

    window.firebaseAuth.onAuthStateChanged(window.auth, (user) => {
        if (authResolved) return;
        authResolved = true;

        if (user) {
            if (!window.location.pathname.endsWith("dashboard.html")) {
                window.location.replace("dashboard.html");
            }
        }
    });

    // Make functions globally available
    window.handleSignIn = handleSignIn;
    window.handleGoogleSignIn = handleGoogleSignIn;
</script>
<style>
    :root {
        --primary-color: #8B1538;
        --secondary-color: #2C3E50;
        --light-color: #ECF0F1;
        --dark-color: #2C3E50;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, var(--light-color) 0%, #fff 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .container {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 400px;
    }

    .logo {
        text-align: center;
        margin-bottom: 2rem;
    }

    .logo i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .logo h1 {
        color: var(--secondary-color);
        font-size: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--secondary-color);
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .btn {
        width: 100%;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        margin-bottom: 1rem;
    }

    .btn-primary:hover {
        background: #6c1028;
    }

    .btn-google {
        background: white;
        color: #333;
        border: 2px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-google:hover {
        background: #f8f9fa;
    }

    .divider {
        text-align: center;
        margin: 1.5rem 0;
        position: relative;
    }

    .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #ddd;
    }

    .divider span {
        background: white;
        padding: 0 1rem;
        position: relative;
        color: #666;
    }

    .signup-link {
        text-align: center;
        margin-top: 1.5rem;
        color: #666;
    }

    .signup-link a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
    }

    .signup-link a:hover {
        text-decoration: underline;
    }

    .error-message {
        background: #fee;
        color: #c33;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <h1>PurposePartner</h1>
            <p style="color: #666; margin-top: 0.5rem;">Sign in to your account</p>
        </div>

        <div id="error-message" class="error-message"></div>

        <form onsubmit="handleSignIn(event)">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required placeholder="your@email.com">
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required placeholder="Enter your password">
            </div>

            <button type="submit" class="btn btn-primary">Sign In</button>
        </form>

        <div class="divider">
            <span>OR</span>
        </div>

        <button onclick="handleGoogleSignIn()" class="btn btn-google">
            <i class="fab fa-google"></i>
            Continue with Google
        </button>

        <div class="signup-link">
            Don't have an account? <a href="signup.html">Sign up</a>
        </div>
    </div>
</body>
</html>







